#cloud-config

coreos:
  etcd:
    name: coreos2
    # generate a new token for each unique cluster from https://discovery.etcd.io/new
    discovery: https://discovery.etcd.io/7863b680910e37870334ae19594de26c
    addr: 10.0.0.101:4001       # For client communication
    peer-addr: 10.0.0.101:7001  # For server communication
  fleet:
    public-ip: 10.0.0.101
  update:
    reboot-strategy: etcd-lock
    group: stable
  units:
    - name: etcd.service
      command: start

    - name: fleet.service
      command: start

    - name: rpc-statd.service
      command: start
      enable: true

    - name: mnt-shared.mount
      command: start
      content: |
        [Mount]
        What=10.0.0.20:/
        Where=/mnt/shared
        Type=nfs

    - name: skydns-config-update.service
      command: start
      content: |
        [Unit]
        Description=Restarts SkyDNS after config update

        [Service]
        ExecStart=/usr/bin/etcdctl exec-watch /skydns/config -- bash -c \
          "/usr/bin/systemctl restart skydns.service"

    - name: skydns.service
      command: start
      content: |
        [Unit]
        Description=SkyDNS service

        Requires=etcd.service
        After=etcd.service

        Requires=docker.service
        After=docker.service

        Requires=skydns-config-update.service
        Before=skydns-config-update.service

        [Service]
        TimeoutStartSec=0
        KillMode=none

        ExecStartPre=-/usr/bin/docker kill skydns
        ExecStartPre=-/usr/bin/docker rm skydns
        ExecStartPre=/usr/bin/docker pull skynetservices/skydns

        ExecStart=/usr/bin/docker run --rm --name skydns \
          -e "ETCD_MACHINES=http://10.0.0.101:4001" \
          -e "SKYDNS_NAMESERVERS=158.38.50.10:53,158.38.49.10:53" \
          -e "SKYDNS_DOMAIN=hesjevik.im" \
          -p 53:53 \
          skynetservices/skydns

        ExecStop=/usr/bin/docker stop skydns

    - name: register-self-skydns.service
      command: start
      content: |
        [Unit]
        Description=Registers this servers DNS record in SkyDNS config

        Requires=etcd.service
        After=etcd.service

        [Service]
        ExecStart=/usr/bin/etcdctl set /skydns/im/hesjevik/coreos2 \
          '{"host":"158.38.57.118","ttl":3600}'
        Type=oneshot

    - name: register-self-as-ns-skydns.service
      command: start
      content: |
        [Unit]
        Description=Registers this server as NS in SkyDNS config

        Requires=etcd.service
        After=etcd.service

        [Service]
        ExecStart=/usr/bin/etcdctl set /skydns/im/hesjevik/dns/ns2 \
          '{"host":"158.38.57.118"}'
        Type=oneshot

hostname: coreos2

users:
  - name: tony
    gecos: Tony Hesjevik
    coreos-ssh-import-github: feskehau
    groups:
      - sudo
      - docker

  - name: andreas
    gecos: Andreas Hopen
    coreos-ssh-import-github: hopeeen
    groups:
      - sudo
      - docker

  - name: knut
    gecos: Knut Lorvik
    coreos-ssh-import-github: superlorre
    groups:
      - sudo
      - docker

write_files:
  - path: /etc/systemd/network/public.network
    permissions: 0644
    owner: root
    content: |
      [Match]
      MACAddress=00:50:56:bb:4c:30

      [Network]
      Address=158.38.57.118/24
      Gateway=158.38.57.1
      DNS=158.38.50.10
      DNS=158.38.49.10

  - path: /etc/systemd/network/private.network
    permissions: 0644
    owner: root
    content: |
      [Match]
      MACAddress=00:50:56:bb:76:3a

      [Network]
      Address=10.0.0.101/24

  - path: /etc/metadata
    permissions: 0644
    content: |
      PUBLIC_IPV4=158.38.57.118
      PRIVATE_IPV4=10.0.0.101
      SHARED_DATA=/mnt/shared

  - path: /etc/conf.d/nfs
    permissions: '0644'
    content: |
      OPTS_RPC_MOUNTD=""